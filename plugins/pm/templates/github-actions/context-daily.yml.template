# Context Engineering Daily Dashboard
#
# This workflow generates a daily report tracking context engineering adoption
# by cross-referencing code repository activity with thoughts repository activity.
#
# Generated by: Catalyst PM Plugin
# Template: plugins/pm/templates/github-actions/context-daily.yml.template

name: Context Engineering Daily Dashboard

on:
  schedule:
    # Run daily at 9:15 AM Central Time (14:15 UTC during CST, 15:15 UTC during CDT)
    # Adjust cron time based on your timezone preference
    - cron: '15 14 * * *'

  workflow_dispatch:
    # Allow manual triggers for testing

env:
  # Project configuration
  PROJECT_KEY: "{{PROJECT_KEY}}"

  # Code repositories to analyze (comma-separated)
  CODE_REPOS: "{{CODE_REPOS}}"

  # Timezone for report timestamps
  TZ: "America/Chicago"

jobs:
  generate-dashboard:
    name: Generate Context Engineering Dashboard
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout thoughts repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for 28-day analysis
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests PyGithub

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Collect GitHub metrics (Code repositories)
        id: github-metrics
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Collecting GitHub metrics for: $CODE_REPOS"

          # Create output directory
          mkdir -p /tmp/metrics

          # Calculate date windows
          SEVEN_DAYS_AGO=$(date -d '7 days ago' '+%Y-%m-%dT%H:%M:%SZ')
          TWENTY_EIGHT_DAYS_AGO=$(date -d '28 days ago' '+%Y-%m-%dT%H:%M:%SZ')

          # Initialize JSON output
          echo '{"7-day": {}, "28-day": {}}' > /tmp/metrics/github-metrics.json

          # For each repository, collect metrics
          IFS=',' read -ra REPOS <<< "$CODE_REPOS"
          for repo in "${REPOS[@]}"; do
            repo=$(echo "$repo" | xargs)  # trim whitespace
            echo "Analyzing repository: $repo"

            # Get contributors (7-day)
            gh api "/repos/$repo/commits?since=$SEVEN_DAYS_AGO" \
              --jq '[.[] | select(.author != null) | .author.login] | unique | .[]' \
              | grep -v -i "claude" \
              > /tmp/metrics/${repo//\//_}_7day_contributors.txt || true

            # Get contributors (28-day)
            gh api "/repos/$repo/commits?since=$TWENTY_EIGHT_DAYS_AGO" \
              --jq '[.[] | select(.author != null) | .author.login] | unique | .[]' \
              | grep -v -i "claude" \
              > /tmp/metrics/${repo//\//_}_28day_contributors.txt || true
          done

          echo "âœ… GitHub metrics collected"
          ls -lh /tmp/metrics/

      - name: Collect thoughts metrics (This repository)
        id: thoughts-metrics
        run: |
          echo "Collecting thoughts repository metrics"

          # Calculate date windows
          SEVEN_DAYS_AGO=$(date -d '7 days ago' '+%Y-%m-%d')
          TWENTY_EIGHT_DAYS_AGO=$(date -d '28 days ago' '+%Y-%m-%d')
          YESTERDAY=$(date -d 'yesterday' '+%Y-%m-%d')

          # Get contributors (7-day)
          git log --since="$SEVEN_DAYS_AGO" --format='%an' \
            | sort -u \
            | grep -v -i "claude" \
            > /tmp/metrics/thoughts_7day_contributors.txt || true

          # Get contributors (28-day)
          git log --since="$TWENTY_EIGHT_DAYS_AGO" --format='%an' \
            | sort -u \
            | grep -v -i "claude" \
            > /tmp/metrics/thoughts_28day_contributors.txt || true

          # Count files by type (7-day)
          for author in $(cat /tmp/metrics/thoughts_7day_contributors.txt); do
            echo "Analyzing $author (7-day)..."

            # Count research files
            research_count=$(git log --since="$SEVEN_DAYS_AGO" --author="$author" \
              --name-only --diff-filter=A \
              | grep -c "^shared/research/" || echo "0")

            # Count plan files
            plans_count=$(git log --since="$SEVEN_DAYS_AGO" --author="$author" \
              --name-only --diff-filter=A \
              | grep -c "^shared/plans/" || echo "0")

            # Count handoff files
            handoffs_count=$(git log --since="$SEVEN_DAYS_AGO" --author="$author" \
              --name-only --diff-filter=A \
              | grep -c "^shared/handoffs/" || echo "0")

            # Count PR files
            prs_count=$(git log --since="$SEVEN_DAYS_AGO" --author="$author" \
              --name-only --diff-filter=A \
              | grep -c "^shared/prs/" || echo "0")

            total=$((research_count + plans_count + handoffs_count + prs_count))

            echo "$author: $total files (research: $research_count, plans: $plans_count, handoffs: $handoffs_count, prs: $prs_count)" \
              >> /tmp/metrics/thoughts_7day_details.txt
          done

          echo "âœ… Thoughts metrics collected"
          cat /tmp/metrics/thoughts_7day_details.txt

      - name: Cross-reference and generate dashboard
        id: generate-dashboard
        env:
          TZ: America/Chicago
        run: |
          echo "Cross-referencing code and thoughts activity..."

          # Merge all code repo contributors
          cat /tmp/metrics/*_7day_contributors.txt 2>/dev/null | sort -u > /tmp/metrics/all_code_contributors_7day.txt || touch /tmp/metrics/all_code_contributors_7day.txt
          cat /tmp/metrics/*_28day_contributors.txt 2>/dev/null | sort -u > /tmp/metrics/all_code_contributors_28day.txt || touch /tmp/metrics/all_code_contributors_28day.txt

          # Find developers with code activity but NO thoughts activity (7-day)
          comm -23 \
            <(sort /tmp/metrics/all_code_contributors_7day.txt) \
            <(sort /tmp/metrics/thoughts_7day_contributors.txt) \
            > /tmp/metrics/not_using_context_engineering.txt

          NOT_USING_COUNT=$(wc -l < /tmp/metrics/not_using_context_engineering.txt | xargs)
          CODE_ACTIVE=$(wc -l < /tmp/metrics/all_code_contributors_7day.txt | xargs)
          THOUGHTS_ACTIVE=$(wc -l < /tmp/metrics/thoughts_7day_contributors.txt | xargs)

          echo "ðŸ“Š Analysis Results:"
          echo "   Code active (7-day): $CODE_ACTIVE developers"
          echo "   Thoughts active (7-day): $THOUGHTS_ACTIVE developers"
          echo "   ðŸš¨ NOT using context engineering: $NOT_USING_COUNT developers"

          if [ $NOT_USING_COUNT -gt 0 ]; then
            echo ""
            echo "Developers not using context engineering:"
            cat /tmp/metrics/not_using_context_engineering.txt
          fi

          # Generate timestamp
          TIMESTAMP=$(date '+%Y-%m-%d at %I:%M %p %Z')

          # Generate simplified dashboard
          cat > context-engineering-daily.md << EOF
          # Context Engineering Adoption - Daily Dashboard

          **Generated**: $TIMESTAMP
          **Project**: $PROJECT_KEY
          **Code Repos**: $CODE_REPOS

          ---

          ## ðŸ“Š Quick Stats (7-Day Window)

          | Metric | Value |
          |--------|-------|
          | **Developers with code activity** | $CODE_ACTIVE |
          | **Developers with thoughts activity** | $THOUGHTS_ACTIVE |
          | **Adoption rate** | $((THOUGHTS_ACTIVE * 100 / CODE_ACTIVE))% |
          | **ðŸš¨ NOT using context engineering** | $NOT_USING_COUNT |

          ---

          ## ðŸš¨ Not Using Context Engineering

          EOF

          if [ $NOT_USING_COUNT -gt 0 ]; then
            echo "**Developers with code activity but NO thoughts activity:**" >> context-engineering-daily.md
            echo "" >> context-engineering-daily.md
            echo "| Developer | Status |" >> context-engineering-daily.md
            echo "|-----------|--------|" >> context-engineering-daily.md
            while IFS= read -r dev; do
              echo "| **$dev** | ðŸ”´ Not using |" >> context-engineering-daily.md
            done < /tmp/metrics/not_using_context_engineering.txt
            echo "" >> context-engineering-daily.md
            echo "**Recommended Action**: Schedule onboarding sessions to introduce context engineering workflow." >> context-engineering-daily.md
          else
            echo "âœ… **All developers with code activity are using context engineering!**" >> context-engineering-daily.md
          fi

          cat >> context-engineering-daily.md << EOF

          ---

          ## ðŸ‘¥ Thoughts Contributors (7-Day)

          EOF

          if [ -f /tmp/metrics/thoughts_7day_details.txt ]; then
            echo "| Developer | Files Created | Breakdown |" >> context-engineering-daily.md
            echo "|-----------|---------------|-----------|" >> context-engineering-daily.md
            while IFS= read -r line; do
              dev=$(echo "$line" | cut -d: -f1)
              stats=$(echo "$line" | cut -d: -f2-)
              echo "| **$dev** | $stats |" >> context-engineering-daily.md
            done < /tmp/metrics/thoughts_7day_details.txt
          else
            echo "No thoughts activity in last 7 days." >> context-engineering-daily.md
          fi

          cat >> context-engineering-daily.md << EOF

          ---

          ## ðŸŽ¯ Recommendations

          EOF

          if [ $NOT_USING_COUNT -gt 0 ]; then
            echo "1. **Priority 1**: Onboard $NOT_USING_COUNT developer(s) to context engineering" >> context-engineering-daily.md
            echo "2. **Priority 2**: Share best practices from active users" >> context-engineering-daily.md
            echo "3. **Priority 3**: Monitor adoption trends weekly" >> context-engineering-daily.md
          else
            echo "1. **Celebrate**: 100% context engineering adoption! ðŸŽ‰" >> context-engineering-daily.md
            echo "2. **Maintain**: Continue encouraging documentation habits" >> context-engineering-daily.md
            echo "3. **Improve**: Consider quality metrics for context files" >> context-engineering-daily.md
          fi

          cat >> context-engineering-daily.md << EOF

          ---

          *Auto-generated by Catalyst PM Plugin â€¢ GitHub Actions*
          *Next report: Tomorrow at 9:15 AM CST*
          EOF

          echo "âœ… Dashboard generated: context-engineering-daily.md"

      - name: Commit and push dashboard
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add context-engineering-daily.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M %Z')
            git commit -m "docs: update context engineering dashboard - $TIMESTAMP"
            git push
            echo "âœ… Dashboard committed and pushed"
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## Context Engineering Dashboard Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Report location**: \`context-engineering-daily.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f /tmp/metrics/not_using_context_engineering.txt ]; then
            NOT_USING=$(wc -l < /tmp/metrics/not_using_context_engineering.txt | xargs)
            echo "ðŸš¨ **$NOT_USING developer(s) not using context engineering**" >> $GITHUB_STEP_SUMMARY
          fi
